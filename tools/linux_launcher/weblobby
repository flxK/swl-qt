#!/bin/bash
# You should have a folder named lib next to this script that contains the
# actual executable and all the libs and qt and gst plugins.
# Don't forget to chmod ug+x weblobby.desktop
cd "`dirname $0`"
if [ ! -d lib ]; then
    echo "The lib folder is not found. Nothing to launch."
    exit 1
fi
export LD_LIBRARY_PATH=$PWD/lib
export QT_PLUGIN_PATH=$PWD/lib
export GST_PLUGIN_PATH=$PWD/lib/gst
if [ -f weblobby.desktop ]; then
    sed -i -e "s,Icon=.*$,Icon=$PWD/lib/icon.png," weblobby.desktop
    sed -i -e "s,Exec=.*$,Exec=$PWD/weblobby," weblobby.desktop
fi
cd lib
if [ ! -d unused ]; then
    echo -n "Checking deps..."
    mkdir unused
    # It used to test all executables, but Steam makes every file executable,
    # including 1.4 gigs in evo_data...
    # So now the executable list should be revieved manually.
    for i in $(for i in *.so* weblobby gstreamer_play gst/* imageformats/* platforms/*; do LD_LIBRARY_PATH= ldd $i; done |
            sed -e '/not /d;/libQt5/d;/libgst/d;/libicu/d;/libboost/d;s/^[[:space:]]*\([^ ]*\).*$/\1/'); do
        mv `basename $i` unused/ &> /dev/null
    done
    echo "Done."
fi
exec ./weblobby $@
